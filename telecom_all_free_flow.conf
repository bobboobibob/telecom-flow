#!name=Telecom All Free Flow (Senplayer Only)
#!desc=针对 Senplayer 客户端的流量伪装为中国电信免流，仅限技术研究。
#!author=Bobboobibob
#!homepage=https://github.com/bobboobibob/telecom-flow
#!system=iOS
#!system_version=15
#!loon_version=3.2.1(372)
#!tag=免流量,Telecom,Senplayer

[Argument]
free_domain = input,"vod.189.cn",tag=默认免流域名,desc=请输入默认免流域名，脚本会自动补充其他域名
user_agent = select,"ChinaTelecomApp/5.0","CTClient/6.0","TelecomBrowser/1.0",tag=伪装User-Agent,desc=选择用于伪装请求的User-Agent
auto_detect = switch,true,tag=自动识别域名,desc=是否启用脚本自动抓取免流域名
rewrite_all = switch,true,tag=全流量伪装,desc=是否将所有流量伪装为免流服务

[General]
dns-server = 114.114.114.114, 223.5.5.5
bypass-tun = 192.168.0.0/16, 10.0.0.0/8, 172.16.0.0/12
skip-proxy = 127.0.0.1, 192.168.0.0/16, 10.0.0.0/8, 172.16.0.0/12
real-ip = 127.0.0.1

[rule]
# 初始规则，仅针对 Senplayer 相关域名
DOMAIN,vod.189.cn,DIRECT
DOMAIN-SUFFIX,285286.xyz,DIRECT # 视频源
DOMAIN-SUFFIX,byusers.me,DIRECT # 用户认证
DOMAIN-SUFFIX,weixin.qq.com,DIRECT # DNS 服务
DOMAIN-SUFFIX,alibaba.com,DIRECT # DNS 服务
IP-CIDR,112.17.0.0/16,DIRECT,no-resolve # China Telecom HangZhou IDC
IP-CIDR,183.250.0.0/16,DIRECT,no-resolve # China Telecom Quanzhou
IP-CIDR,221.199.0.0/16,DIRECT,no-resolve # CHINANET NINGXIA ZHONGWEI IDC
IP-CIDR,223.5.5.5/32,DIRECT,no-resolve
IP-CIDR,114.114.114.114/32,DIRECT,no-resolve
GEOIP,CN,DIRECT
FINAL,PROXY

[rewrite]
# 仅针对 byusers.me 重定向，285286.xyz 不重定向，仅修改头
^http(s?)://.*\.byusers\.me http$1://vod.189.cn/$2 header-replace User-Agent {$user_agent} enable={rewrite_all}
# 为 285286.xyz 添加伪装头，不改变 URL
^http(s?)://.*\.285286\.xyz header-replace User-Agent {$user_agent} enable={rewrite_all}

[host]
*.189.cn = 114.114.114.114
*.cloud.189.cn = 114.114.114.114
*.mkt.189.cn = 114.114.114.114

[script]
# 针对 Senplayer 的域名执行脚本
http-request ^https?:\/\/.*\.(285286\.xyz|byusers\.me) script-path=https://raw.githubusercontent.com/bobboobibob/telecom-flow/main/detect_free_domain.js, tag=自动识别免流域名, enable={auto_detect}, argument=[{free_domain},{user_agent},{auto_detect}]
http-response ^https?:\/\/.*\.(285286\.xyz|byusers\.me) script-path=https://raw.githubusercontent.com/bobboobibob/telecom-flow/main/pseudo_free_flow.js, requires-body=true, tag=伪装免流流量, enable={rewrite_all}, argument=[{free_domain},{user_agent},{rewrite_all}]
cron "0 0 * * *" script-path=https://raw.githubusercontent.com/bobboobibob/telecom-flow/main/update_rules.js, timeout=300, tag=定时更新规则, enable={auto_detect}, argument=[{free_domain}]

[mitm]
# 初始 MitM 列表，仅针对 Senplayer
hostname = vod.189.cn, *.285286.xyz, *.byusers.me, *.weixin.qq.com, *.alibaba.com

#!name=Telecom All Free Flow
#!desc=自动识别中国电信免流域名并伪装所有流量为免流，仅限技术研究。支持动态规则更新和用户自定义配置。
#!author=Bobboobibob
#!homepage=https://github.com/bobboobibob/telecom-flow
#!system=iOS
#!system_version=15
#!loon_version=3.2.1(372)
#!tag=免流量,Telecom,Dynamic

[Argument]
free_domain = input,"vod.189.cn",tag=默认免流域名,desc=请输入默认免流域名，脚本会自动补充其他域名
user_agent = select,"ChinaTelecomApp/5.0","CTClient/6.0","TelecomBrowser/1.0",tag=伪装User-Agent,desc=选择用于伪装请求的User-Agent
auto_detect = switch,true,tag=自动识别域名,desc=是否启用脚本自动抓取免流域名
rewrite_all = switch,true,tag=全流量伪装,desc=是否将所有流量伪装为免流服务

[General]
dns-server = 119.29.29.29, 223.5.5.5
bypass-tun = 192.168.0.0/16, 10.0.0.0/8, 172.16.0.0/12
skip-proxy = 127.0.0.1, 192.168.0.0/16, 10.0.0.0/8, 172.16.0.0/12
real-ip = 127.0.0.1

[rule]
DOMAIN-SUFFIX,189.cn,DIRECT
DOMAIN-SUFFIX,cloud.189.cn,DIRECT
DOMAIN-SUFFIX,mkt.189.cn,DIRECT
DOMAIN-SUFFIX,iqiyi.com,DIRECT
DOMAIN-SUFFIX,youku.com,DIRECT
DOMAIN-SUFFIX,tencent.com,DIRECT
DOMAIN-SUFFIX,damai.cn,DIRECT
DOMAIN-SUFFIX,dangbei.com,DIRECT
DOMAIN-SUFFIX,dangbei.net,DIRECT
DOMAIN-SUFFIX,ctyun.cn,DIRECT
DOMAIN-SUFFIX,telecom.cn,DIRECT
DOMAIN,vod.189.cn,DIRECT
IP-CIDR,112.17.0.0/16,DIRECT,no-resolve # China Telecom HangZhou IDC
IP-CIDR,183.250.0.0/16,DIRECT,no-resolve # China Telecom Quanzhou
IP-CIDR,221.199.0.0/16,DIRECT,no-resolve # CHINANET NINGXIA ZHONGWEI IDC
IP-CIDR,223.5.5.5/32,DIRECT,no-resolve
IP-CIDR,119.29.29.29/32,DIRECT,no-resolve
GEOIP,CN,DIRECT
FINAL,PROXY

[rewrite]
^http(s?)://(.*) http$1://vod.189.cn/$2 header-replace User-Agent {$user_agent} enable={rewrite_all}

[host]
*.189.cn = 119.29.29.29
*.cloud.189.cn = 119.29.29.29
*.mkt.189.cn = 119.29.29.29
*.iqiyi.com = 119.29.29.29
*.dangbei.com = 119.29.29.29
*.ctyun.cn = 119.29.29.29

[script]
http-request ^https?:\/\/.* script-path=https://raw.githubusercontent.com/bobboobibob/telecom-flow/main/detect_free_domain.js, tag=自动识别免流域名, enable={auto_detect}, argument=[{free_domain},{user_agent},{auto_detect}]
http-response ^https?:\/\/.* script-path=https://raw.githubusercontent.com/bobboobibob/telecom-flow/main/pseudo_free_flow.js, requires-body=true, tag=伪装免流流量, enable={rewrite_all}, argument=[{free_domain},{user_agent},{rewrite_all}]
cron "0 0 * * *" script-path=https://raw.githubusercontent.com/bobboobibob/telecom-flow/main/update_rules.js, timeout=300, tag=定时更新规则, enable={auto_detect}, argument=[{free_domain}]

[mitm]
hostname = *.189.cn, *.cloud.189.cn, *.mkt.189.cn, *.iqiyi.com, *.youku.com, *.tencent.com, *.damai.cn, *.dangbei.com, *.dangbei.net, *.ctyun.cn, *.telecom.cn, vod.189.cn
